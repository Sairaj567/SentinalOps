// =============================================================================
// SentinelOps - Vulnerability Model
// =============================================================================

import mongoose, { Document, Schema } from 'mongoose';

export interface IVulnerability extends Document {
  vulnId: string;
  cveId?: string;
  title: string;
  description: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  cvssScore?: number;
  source: 'trivy' | 'semgrep' | 'dependency-check' | 'gitleaks' | 'manual';
  scanType: 'container' | 'sast' | 'dependency' | 'secret' | 'dast';
  affectedComponent: {
    name: string;
    version: string;
    type: string;
    path?: string;
  };
  fixedVersion?: string;
  remediation?: string;
  references: string[];
  status: 'open' | 'in_progress' | 'fixed' | 'accepted' | 'false_positive';
  detectedAt: Date;
  fixedAt?: Date;
  pipelineBuild?: string;
  projectName: string;
  assignedTo?: string;
  dueDate?: Date;
  tags: string[];
}

const VulnerabilitySchema = new Schema<IVulnerability>({
  vulnId: {
    type: String,
    required: true,
    unique: true,
    index: true,
  },
  cveId: {
    type: String,
    index: true,
  },
  title: {
    type: String,
    required: true,
  },
  description: {
    type: String,
    required: true,
  },
  severity: {
    type: String,
    required: true,
    enum: ['low', 'medium', 'high', 'critical'],
    index: true,
  },
  cvssScore: {
    type: Number,
    min: 0,
    max: 10,
  },
  source: {
    type: String,
    required: true,
    enum: ['trivy', 'semgrep', 'dependency-check', 'gitleaks', 'manual'],
    index: true,
  },
  scanType: {
    type: String,
    required: true,
    enum: ['container', 'sast', 'dependency', 'secret', 'dast'],
    index: true,
  },
  affectedComponent: {
    name: { type: String, required: true },
    version: { type: String, required: true },
    type: { type: String, required: true },
    path: { type: String },
  },
  fixedVersion: {
    type: String,
  },
  remediation: {
    type: String,
  },
  references: [{
    type: String,
  }],
  status: {
    type: String,
    required: true,
    enum: ['open', 'in_progress', 'fixed', 'accepted', 'false_positive'],
    default: 'open',
    index: true,
  },
  detectedAt: {
    type: Date,
    required: true,
    default: Date.now,
  },
  fixedAt: {
    type: Date,
  },
  pipelineBuild: {
    type: String,
  },
  projectName: {
    type: String,
    required: true,
    index: true,
  },
  assignedTo: {
    type: String,
  },
  dueDate: {
    type: Date,
  },
  tags: [{
    type: String,
  }],
}, {
  timestamps: true,
  collection: 'vulnerabilities',
});

// Indexes
VulnerabilitySchema.index({ severity: 1, status: 1 });
VulnerabilitySchema.index({ detectedAt: -1 });
VulnerabilitySchema.index({ cveId: 1, projectName: 1 });

export const Vulnerability = mongoose.model<IVulnerability>('Vulnerability', VulnerabilitySchema);
